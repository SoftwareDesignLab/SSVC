import os
from pathlib import Path
from flask import make_response, jsonify
from flask_restful import Resource
from ssvc_backend.exploit_status.exploit_status_backend import get_exploit_status

class ExploitStatusApi(Resource):
    def get(self, cve_id):
        """
        Method to get the exploit status for a specific cve
        :return:
        """

        # access exploit status setting the working directory into
        status = get_exploit_status(cve_id, working_dir=os.path.join(os.path.dirname(__file__), "..", ".."), print_status=False)

        # package respones into dictionary to convert into json
        if status is not None:
            # respond normally with a cave id and an the exploit status
            response_data = {
                "cveId": cve_id,
                "exploitStatus": status
            }
        else:
            # if the status is None, an error occured, send a message to the
            response_data = {
                "cveId": cve_id,
                "message": "There was an error with your request. Please ensure you inputted a valid CVE ID and proper delay with requests."
            }
        response = make_response(jsonify(response_data), 200 if status is not None else 400)
        response.headers["Content-Type"] = "application/json"
        return response
