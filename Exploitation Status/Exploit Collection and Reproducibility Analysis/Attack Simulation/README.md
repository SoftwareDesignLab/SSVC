# Installation
## Installing KVM/Qemu
This is the software that is used to run virtual machines on your host machine.

https://phoenixnap.com/kb/ubuntu-install-kvm follow this, except we will be using virt-manager remotely
create an Ubuntu 22.04 LTS virtual machine. To make this process easier, it could be useful to install virt-manager on your own computer. This is available through homebrew for mac, and through apt on Ubuntu. If using windows, install WSL and use virt-manager through there. You will need to copy over your SSH key, which you can do by running `ssh-keygen` and then `ssh-copy-id` to the server that you have installed kvm on.
## Installing CAPEv2
This is the software used to run and analyze malicious pieces of code.

The following steps take place on the Ubuntu 22.04 LTS virtual machine you have just created. https://capev2.readthedocs.io/en/latest/installation/host/installation.html do not use qemu-kvm.sh, only cape2.sh. Use the kvmremote machinery. Copy over CAPEv2 configuration files from the Github repository. You will need to modify at least cuckoo.conf and kvmremote.conf to ensure that the IP addresses are correct. From within cape-server VM, `ssh-copy-id` to the host server so that kvmremote can work without asking for a password every time. Run `sudo apt install libvirt-dev` and `sudo apt install virtinst` within the cape-server VM. From /opt/CAPEv2 dir and as cape user (`sudo su cape`): `poetry run pip3 install libvirt-python`. You need to also generate key for capev2: https://capev2.readthedocs.io/en/latest/usage/api.html. Note the username and password when creating the CAPEv2 superuser.

## Installing Caldera
This is the software used to simulate both an attacker and a response to the attacker. 

The following steps take place on the CAPEv2 virtual machine. https://caldera.readthedocs.io/en/latest/Installing-CALDERA.html <- use the concise installation guide. Running caldera in a service:
https://askubuntu.com/questions/1063153/systemd-service-working-directory-not-change-the-directory 
https://medium.com/codex/setup-a-python-script-as-a-service-through-systemctl-systemd-f0cc55a42267   

## Installing Elasticsearch/Kibana
This is the software used to collect logs in real-time into an easily searchable interface from both CAPEv2 itself and the victim virtual machines.

Create another Ubuntu 22.04 LTS virtual machine. Allocate 4 cores and 8 GB of RAM, along with at least 80 GB of storage to ensure no slowdowns occur. Follow these instructions to install Elasticsearch https://www.elastic.co/guide/en/elasticsearch/reference/current/deb.html. Then follow these instructions to install Kibana https://www.elastic.co/guide/en/kibana/current/deb.html 

## Integrating CAPEv2 with Elasticsearch
https://www.postgresql.org/docs/current/app-psql.html <- use and login as cape user on the CAPEv2 virtual machine with the information below (the db connection string)
Run the following command in psql client: `ALTER SYSTEM SET track_commit_timestamp = on;`
Capev2 db connection string: connection = postgresql://cape:SuperPuperSecret@localhost:5432/cape                                          
Follow this guide and install on the Elasticsearch virtual machine https://episyche.com/blog/how-to-install-an-elastic-enterprise-search-appsearch-on-ubuntu 

https://discuss.elastic.co/t/enterprise-search-unable-to-start/306151 <- to fix enterprise search not starting

https://github.com/elastic/connectors-python <- to connect CAPEv2 to enterprise search. See github repo for configuration file, you may need to modify IP addresses. 

## Creating Victim Windows 10 Virtual Machines
Download the latest windows 10 ISO from here: https://www.microsoft.com/en-us/software-download/windows10. If you are using windows, you may have to use the windows 10 install media creator, make sure to use the ISO option. Upload the ISO to the host server using sftp or similar. Copy the ISO to `/var/lib/libvirt/images`. From within virt-manager, create a new virtual machine, and point it to the ISO that you just copied over. Allocate at least 2 CPU cores, 3072 MiB of RAM, and 40 GB of storage, to ensure that Windows runs properly. If you have more resources, you can allocate more cores to speed up the analysis process. Install windows as normal. Make sure to set a password, either during installation or after, as it is required for Ansible to work properly. 

https://capev2.readthedocs.io/en/latest/installation/guest/index.html follow this guide to prepare the virtual machine. Make sure to skip the step that says “Network Connectivity Status Indicator, Error Reporting, etc” otherwise the environment setup code will fail to run. 

Open powershell as an administrator, and run the command `winrm quickconfig -q`. This allows Ansible to connect to the virtual machine. Download and install https://learn.microsoft.com/en-us/sysinternals/downloads/autologon on the virtual machine. Download and install https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon on the virtual machine. Configuration files can be found in the github repository. Download and install https://www.elastic.co/downloads/beats/winlogbeat on the virtual machine. Configuration files can be found in the github repository; you may need to modify the IP address. It should point to the IP of the Elasticsearch server. 
## Installing Apache Guacamole in Docker
This is the software used to allow easy remote access and human interaction to the victim virtual machines while analysis is taking place.

Install this on the host machine. https://docs.docker.com/engine/install/ubuntu/ https://www.linode.com/docs/guides/installing-apache-guacamole-through-docker/ 

Need to add a VNC server to the VM configuration on each victim virtual machine, easy to do through virt-manager, then add each machine to Apache Guacamole through the Web UI. You can find the port number within the machine config in virt-manager. Make sure to uncheck the auto checkbox so that the port does not change. Use the dhcp hostname as the hostname in the guacamole web UI. 

# Usage
## Prerequisites
```
sudo apt install python3
python3 -m pip install --user ansible
python3 -m pip install --user ansible-runner
sudo apt-get update && sudo apt-get install -y ansible
```

## Configuration 
There are three relevant configuration files: env_setup.json, cape-analyze-config.json, and cve_requirements.json.

To correctly configure these files, it is important that you have access to a detailed description of a CVE, along with some proof of concept code, for example: https://github.com/vusec/fpvi-scsb/tree/main/fpvi_firefox_exploit. 
### env_setup.json
generally, the defaults should be correct, but is important to check the paths and make sure that all of the files are in the correct places in order to ensure a successful simulation
### cape-analyze-config.json
you will need to acquire an API token from CAPEv2 and fill in cape_token with its value
on the CAPEv2 virtual machine, run the following commands 
```
cd /opt/CAPEv2/web/
sudo su cape
poetry run python3 manage.py createsuperuser
```
This will allow you to generate the API token. Take this token and insert it into the config file
file_to_submit is the path of the file that you will be using for attack simulation.
name is the name of the CVE that you are simulating. 
you will need to change cape_ip to the IP of the CAPEv2 virtual machine.
### cve_requirments.json
follow the structure outlined in this configuration file to define what software should be installed onto the Windows 10 virtual machine before the attack simulation is run
the software and version that you specify must be present in the Chocolatey repository. This is easy to check by visiting the website: https://community.chocolatey.org/packages and searching for the software that you plan to install
## Analysis
Run the following command on the host machine: `ansible-playbook env-setup.yml -i hosts`.

This will set up a Windows 10 virtual machine with the packages that you have configured, and start an analysis in CAPEv2 of the file that you have specified. The results will be saved as a json file in the directory that you have run this command, and they are also available in the CAPEv2 web interface. 

